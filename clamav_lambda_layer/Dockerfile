FROM amazonlinux:2023

WORKDIR /home/build

RUN set -e

RUN echo "Prepping ClamAV"

RUN rm -rf bin
RUN rm -rf lib

RUN dnf update -y

RUN dnf install -y clamav-0.103.9-1.amzn2023.0.2  \
    clamav-lib-0.103.9-1.amzn2023.0.2 \
    clamav-update-0.103.9-1.amzn2023.0.2 \
    json-c \
    pcre2 \
    libtool-ltdl \
    libxml2 \
    bzip2-libs \
    xz-libs \
    gnutls \
    nettle \
    zip

RUN mkdir -p bin
RUN mkdir -p lib
RUN mkdir -p var/lib/clamav
RUN chmod -R 777 var/lib/clamav

COPY ./freshclam.conf .
RUN cp freshclam.conf bin/freshclam.conf



RUN cp /usr/bin/clamscan /usr/bin/freshclam bin/. && \
    chmod +x bin/clamscan
RUN cp -R /usr/lib64/* lib/.

RUN dnf install shadow-utils -y

RUN groupadd clamav
RUN useradd -g clamav -s /bin/false -c "Clam Antivirus" clamav

RUN zip -r9 clamav_lambda_layer.zip bin
RUN zip -r9 clamav_lambda_layer.zip lib
RUN zip -r9 clamav_lambda_layer.zip var
RUN zip -r9 clamav_lambda_layer.zip /etc